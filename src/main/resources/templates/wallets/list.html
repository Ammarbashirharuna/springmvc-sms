<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}"
      lang="en">
<head>
    <title>Wallets List</title>
    <script>
        function formatNumber(num) {
            let formattedNumber = num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            let sign = num < 0 ? "" : "+"; // Add + for positive numbers
            return sign + formattedNumber + " â‚¦";
        }

        function fetchWalletsByClass() {
            console.log("Fetching wallets...");
            let className = document.getElementById("className").value;
            console.log("Selected class name:", className);
            let url = "/fees/walletsByClass?className=" + encodeURIComponent(className);
            console.log("Fetching from URL:", url);

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log("Data received:", data);
                    let table = document.getElementById("walletsTable");
                    table.innerHTML = `
                        <tr>
                            <th>ID</th>
                            <th>Balance</th>
                            <th>Student Name</th>
                            <th>Phone Number</th>
                            <th>Registration No.</th>
                            <th>Class</th>
                            <th>Admission Type</th>
                            <th>Actions</th>
                        </tr>
                    `;
                    let totalDebt = 0;
                    data.forEach(wallet => {
                        // Sum only negative balances (debts)
                        if (wallet.balance < 0) {
                            totalDebt += wallet.balance;
                        }

                        let row = table.insertRow();
                        row.insertCell(0).innerHTML = wallet.id;
                        row.insertCell(1).innerHTML = formatNumber(wallet.balance);
                        row.insertCell(2).innerHTML = wallet.studentName;
                        row.insertCell(3).innerHTML = wallet.phoneNumber;
                        row.insertCell(4).innerHTML = wallet.regNo;
                        row.insertCell(5).innerHTML = wallet.studentClass;
                        row.insertCell(6).innerHTML = wallet.admissionType;

                        let actionsCell = row.insertCell(7);
                        let payLink = document.createElement("a");
                        payLink.className = "dynamic-link";
                        payLink.href = "/fees/pay/" + wallet.id;
                        payLink.innerText = "Pay";
                        actionsCell.appendChild(payLink);

                        actionsCell.innerHTML += "&nbsp;"; // Add a space

                        let viewTransactionsLink = document.createElement("a");
                        viewTransactionsLink.className = "dynamic-link";
                        viewTransactionsLink.href = "/fees/transactions/" + wallet.id;
                        viewTransactionsLink.innerText = "Transactions";
                        actionsCell.appendChild(viewTransactionsLink);

                        actionsCell.innerHTML += "&nbsp;"; // Add a space

                        let editBalanceLink = document.createElement("a");
                        viewTransactionsLink.className = "dynamic-link";
                        viewTransactionsLink.href = "/fees/edit/" + wallet.id;
                        viewTransactionsLink.innerText = "Edit Balance";
                        actionsCell.appendChild(viewTransactionsLink);
                    });

                    // Add total debt row
                    let totalRow = table.insertRow();
                    let cell = totalRow.insertCell(0);
                    cell.colSpan = 7;
                    cell.innerHTML = '<b>Total Debt:</b>';
                    let totalCell = totalRow.insertCell(1);
                    totalCell.innerHTML = '<b>' + formatNumber(totalDebt) + '</b>';
                })
                .catch(error => console.error('Error fetching wallets:', error));
        }

        // Function to call fetchWalletsByClass on page load if className has a value
        window.onload = function() {
            let classSelect = document.getElementById("className");
            if (classSelect.value) {
                fetchWalletsByClass();
            }
        };
    </script>
</head>
<body>
<section layout:fragment="body">
    <article class="list-page">
        <div class="list-header">
            <h1>Wallets List</h1>
        </div>

        <!-- Form to filter students by class -->
        <form class="list-form-layout" method="post" th:action="@{/fees/setTermDebt}">
            <div class="list-form">
                <div class="form-group">
                    <label for="className">Select Class:</label>
                    <select id="className" name="className" onchange="fetchWalletsByClass()">
                        <option th:each="cl : ${classes}" th:value="${cl.sectionId + ' ' + cl.className}" th:text="${cl.sectionId + ' ' + cl.className}"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="full">Full Amount:</label>
                    <input id="full" type="text" name="full" required />
                </div>
                <div class="form-group">
                    <label for="partial">Partial Amount:</label>
                    <input id="partial" type="text" name="partial" required />
                </div>
            </div>
            <div class="form-group-btn">
                <button type="submit">Debit Students</button>
            </div>
        </form>
        <div class="table-container">
            <table id="walletsTable">
                <!-- Table rows will be dynamically inserted here -->
            </table>
        </div>
    </article>
</section>
</body>
</html>
